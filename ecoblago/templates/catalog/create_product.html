{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/includes/navbar.css' %}">
{% endblock links %}

{% block navbar %}
{% include 'includes/navbar.html' %}
{% endblock navbar %}

{% block main %}
<main class="txt-primary">
  <div class="row main-row">
    <div class="col-12 col-md-10 col-xl-9">
      <div class="wrapper">
        <div class="profile-bar">
          <p>{% trans "Создать обьявление" %}</p>
          <div class="section">
            <p>{% trans "Название" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input type="text" name="name" id="product-name-input" placeholder="Название товара" required>
                <div>{% trans "Название товара" %}</div>
              </div>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Цена" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input type="text" name="name" id="product-cost-input" placeholder="Цена товара" required>
                <div>{% trans "Цена товара" %}</div>
              </div>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Категория" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input type="text" class="select-field" name="name" id="product-category-input"
                  placeholder="Название товара" required>
                <div>{% trans "Категория" %}</div>
              </div>
              <dialog class="popup" style="min-height: 300px; min-width: 300px;">
                <div style="padding: 1rem;">
                  <div class="row options-row">
                    {% for category in categories %}
                    <div style="margin-bottom: 0.5rem;" class="col-12 col-md-6 col-xl-4">
                      <div class="select-option">
                        <i class="fa-solid fa-list" style="color: var(--txt-primary); font-size: 1rem; margin: 0 0.5rem;"></i>
                        <p>{{ category.name }}</p>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </dialog>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Фото" %}</p>
            <hr>
            <div class="row image-container-row">
              <div class="col-10 col-md-5 col-xl-4">
                <div class="image-container" data-has-image="false">
                  <input type="file" id="add-image-input1" class="add-image-input" accept="image/*"
                    style="display: none;">
                  <label for="add-image-input1" class="add-image-label">Добавить фото</label>
                </div>
              </div>
              <div class="col-10 col-md-5 col-xl-4">
                <div class="image-container" data-has-image="false">
                  <input type="file" id="add-image-input2" class="add-image-input" accept="image/*"
                    style="display: none;">
                  <label for="add-image-input2" class="add-image-label">Добавить фото</label>
                </div>
              </div>
              <div class="col-10 col-md-5 col-xl-4">
                <div class="image-container" data-has-image="false">
                  <input type="file" id="add-image-input3" class="add-image-input" accept="image/*"
                    style="display: none;">
                  <label for="add-image-input3" class="add-image-label">Добавить фото</label>
                </div>
              </div>
              <div class="col-10 col-md-5 col-xl-4">
                <div class="image-container" data-has-image="false">
                  <input type="file" id="add-image-input4" class="add-image-input" accept="image/*"
                    style="display: none;">
                  <label for="add-image-input4" class="add-image-label">Добавить фото</label>
                </div>
              </div>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Описание" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="textarea-field-wrapper">
                <textarea class="textarea-field" type="text" name="description" id="product-description-input"
                  placeholder="Название товара" required></textarea>
                <div>{% trans "Описание" %}</div>
              </div>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Местоположение" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input class="select-field" type="text" name="location" id="product-region-input" placeholder="Локация"
                  required>
                <div>{% trans "Регион" %}</div>
              </div>
              <dialog class="popup" style="min-height: 300px; min-width: 300px;">
                <div style="padding: 1rem;">
                  <div class="row options-row">
                    {% for region in regions %}
                    <div style="margin-bottom: 0.5rem;" class="col-12 col-md-6 col-xl-4">
                      <div class="select-option">
                        <i class="fa-solid fa-city" style="color: var(--txt-primary); font-size: 1rem; margin: 0 0.5rem;"></i>
                        <p>{{ region.name }}</p>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </dialog>
            </div>
            <div style="display: none; max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input class="select-field" type="text" name="location" id="product-city-input" placeholder="Локация"
                  required>
                <div>{% trans "Город" %}</div>
              </div>
              <dialog class="popup" style="min-height: 300px; min-width: 500px;">
                <div style="padding: 1rem;">
                  <div class="row options-row">

                  </div>
                </div>
              </dialog>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Номер телефона" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input class="input-field" type="text" name="phone-number" id="product-phone-number-input"
                  placeholder="Номер телефона" required>
                <div>{% trans "Номер телефона" %}</div>
              </div>
            </div>
          </div>
          <div class="section">
            <p>{% trans "Почта" %}</p>
            <hr>
            <div style="max-width: 500px;">
              <div style="margin-top: 1rem;" class="input-field-wrapper">
                <input class="input-field" type="text" name="email" id="product-email-input" placeholder="Почта"
                  required>
                <div>{% trans "Почта" %}</div>
              </div>
            </div>
          </div>
          <button style="margin-top: 2.5rem;" id="publish-btn">{% trans "Опубликовать" %}</button>
        </div>
        {% include 'includes/footer.html' %}
      </div>
    </div>
  </div>
</main>
<script>
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>

<script>
  // Showing dialogs when inputs are clicked
  const selectFields = document.querySelectorAll(".select-field");
  selectFields.forEach((field) => {
    field.addEventListener("click", () => {
      field.parentElement.parentElement.querySelector(".popup").showModal();
    });
  });

  // Closing the dialogs
  document.addEventListener("click", (e) => {
    if (e.target.closest(".options-row") == null || e.target.classList.contains("options-row")) {
      return;
    }

    const target = e.target;
    target.closest('.popup').close();
    const selected = target.closest('.select-option').querySelector('p').textContent;
    target.closest('.popup').previousElementSibling.querySelector('.select-field').value = selected;

    if (target.closest('.popup').parentElement.firstElementChild.querySelector('.select-field').id == "product-region-input") {
      getCitiesByRegion(selected);
      document.getElementById('product-city-input').parentElement.parentElement.style.display = 'block';
    }
  });

  function getCitiesByRegion(region) {
    $.ajax({
      method: "POST",
      url: "{% url 'catalog:create' %}",
      data: {
        "region": region,
        "action": "get-cities-by-region",
        "csrfmiddlewaretoken": CSRF_TOKEN,
      },
      success: (data) => {
        const success = data["success"];
        if (!success) {
          showToast("Произошла ошибка при получении городов", false);
          return;
        }

        const cities = data["cities"];
        const cityInput = document.getElementById("product-city-input");
        cityInput.innerHTML = "";
        let optionsRow = document.getElementById("product-city-input").parentElement.nextElementSibling.querySelector(".options-row");
        optionsRow.innerHTML = "";
        cities.forEach((city) => {
          let el = document.createElement("div");
          el.className = "col-12 col-md-6 col-xl-4";
          el.style = 'margin-bottom: 0.5rem;';  

          let selectOption = document.createElement("div");
          selectOption.className = "select-option";

          let icon = document.createElement("i");
          icon.className = "fa-solid fa-city";
          icon.style = "color: var(--txt-primary); font-size: 1rem; margin-right: 0.5rem;";
          selectOption.appendChild(icon);

          let p = document.createElement("p");
          p.textContent = city["name"];
          selectOption.appendChild(p);

          el.appendChild(selectOption);
          optionsRow.appendChild(el);
        });
      },
      error: (xhr, errmsg, err) => {
        showToast("Произошла ошибка при получении городов", false);
        console.log(xhr.status + ":" + xhr.responseText)
      }
    })
  }
  
  $("#publish-btn").on("click", createProduct);
  
  // Sending request to create a product
  function createProduct() {
    const title = $("#product-name-input").val();
    const category = $("#product-category-input").val();
    const region = $("#product-region-input").val();
    const city = $("#product-city-input").val();
    const phone_number = $("#product-phone-number-input").val();
    const cost = $("#product-cost-input").val();
    const description = $("#product-description-input").val();
    const email = $("#product-email-input").val();

    let images = [];
    addImageInputs.forEach((imageInput) => {
      if (imageInput.files.length > 0) {
        images.push(imageInput.files[0]);
      }
    });

    let formData = new FormData();
    formData.append("csrfmiddlewaretoken", CSRF_TOKEN);
    formData.append("action", "create-product");
    formData.append("title", title);
    formData.append("category_name", category);
    formData.append("region_name", region);
    formData.append("city_name", city);
    formData.append("phone_number", phone_number);
    formData.append("cost", cost);
    formData.append("description", description);
    formData.append("email", email);
    images.forEach((image, index) => {
      formData.append('gallery_images', image);
    });

    $.ajax({
      method: "POST",
      url: "{% url 'catalog:create' %}",
      data: formData,
      dataType: "json",
      processData: false,
      contentType: false,
      beforeSend: function () {
        $("#publish-btn").text("Подождите...");
        $("#publish-btn").attr("disabled", "true");
      },
      success: (data) => {
        const success = data["success"];
        if (success) {
          showToast("Обявление успешно добавлено", true);
          setTimeout(() => {
            window.location.href = "{% url 'catalog:catalog' %}";
          }, 3000);
        } else {
          showToast(data["error"], false);
        }
      },
      error: function (xhr, errmsg, err) {
        console.log(xhr.status + ":" + xhr.responseText)
        showToast("Произошла ошибка при добавлении обявления", false);
      },
      complete: function () {
        $("#publish-btn").text("Подать обявление");
        $("#publish-btn").removeAttr("disabled");
      }
    })
  }


  // Adding images to the image containers
  const addImageInputs = document.querySelectorAll('.add-image-input');
  addImageInputs.forEach((imageInput) => {
    imageInput.onchange = () => {
      const imageContainer = imageInput.closest(".image-container");
      const hasImage = imageContainer.getAttribute('data-has-image');
      const addImageLabel = imageInput.nextElementSibling;

      if (hasImage === 'false') {
        const reader = new FileReader();
        reader.onload = (e) => {
          imageContainer.style.backgroundImage = `url(${e.target.result})`
          imageContainer.style.backgroundSize = 'cover';
          imageContainer.dataset.hasImage = 'true';
          addImageLabel.textContent = '';
          imageInput.setAttribute('disabled', 'true');
        }
        reader.readAsDataURL(imageInput.files[0]);
      }
    };
  });
</script>

<style>
  .select-option {
    cursor: pointer;
  }

  .select-option>img {
    width: 30px;
    height: 30px;

    border-radius: 10%;
    margin-right: 0.5rem;
  }

  .select-option>p {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;

    margin: 0;
    padding: 0;
  }

  p {
    color: var(--txt-primary);
  }

  .select-option {
    padding: 0.2rem;
    border-radius: 0.5rem;
    border: 2px solid gray;
    background: transparent;

    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
  }

  .popup::backdrop {
    background-color: #33595D;
    opacity: 0.3;
  }

  .popup::-webkit-scrollbar {
    width: 10px;
  }

  .popup::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .popup::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  .popup::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .popup {
    background-color: var(--background-color);
    overflow-x: hidden;
    border: none;
    outline: none;
    border-radius: 0.5rem;

    max-height: 80vh;
  }

  dialog[open] {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .image-container-row {
    display: flex;
    flex-direction: row;
    gap: 1rem;
  }

  .add-image-label {
    font-family: 'Inter', sans-serif;
    font-size: 1rem;

    background: transparent;
    cursor: pointer;
  }

  .image-container {
    width: 100%;
    height: 200px;
    background-color: #adadad;
    opacity: 0.7;
    border-radius: 0.5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  #publish-btn {
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    font-size: 1.25rem;

    border: none;
    outline: none;
    border-radius: 0.25rem;
    background-color: var(--green-primary);
    color: white;

    padding: 0.5rem 1rem;
  }

  #publish-btn:hover {
    filter: brightness(92%);
  }

  .profile-bar .section hr {
    width: 100%;
    height: 1px;
    border: none;
    margin: 0.5rem 0;
  }

  .profile-bar .section>p {
    font-size: 1.5rem;
    font-weight: 500;
    font-family: 'Inter', sans-serif;
    margin: 0;
  }

  .profile-bar>.section {
    padding-top: 2rem;
  }

  .profile-bar {
    width: 100%;
    padding: 1rem 2.5rem 0 2.5rem;
  }

  .wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    background-color: var(--background-color);
    min-height: 100vh;
  }


  .main-row {
    width: 100%;
    min-height: 100vh;

    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: flex-start;
  }

  .profile-bar>p {
    font-size: 2rem;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    margin: 0;
  }

  body {
    overflow-x: hidden;
  }

  textarea {
    min-height: 250px;
  }
</style>
{% endblock main %}
